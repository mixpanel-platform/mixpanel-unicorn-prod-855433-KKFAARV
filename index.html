<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/cache/8ea4a91cd70389613b271278f237f282/bundle/reports.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-dateFormat/1.0/jquery.dateFormat.js"></script>
    <script src="https://cdn.rawgit.com/mixpanel-platform/mixpanel-unicorn-1-855433-K9huT8m/master/md5.js"></script>
    <script src="https://cdn.rawgit.com/mp-christine/mp-christine/master/platform/assets/json2csv.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/mixpanel-platform/mixpanel-unicorn-1-855433-K9huT8m/master/styles.css">
</head>

<body class="mixpanel-platform-body">
  <h2>Enter Project Credentials</h2>
  <div class="mixpanel-platform-section">
      <h1 style="display:none;" class="myDisplay" id="displayName"></h1>
      <div style="display: inline-block;position: relative;padding: 0px 0px 0px 12px;margin: 0px 0px 15px 10px;"><a class="editMPT myDisplay" style="display:none;" id="changeSubmitCred"></a></div>
      <input style="float: left;" class="myInput credInput" placeholder="Project Name" id="projectName"/>
      <input style="float: left;" class="myInput credInput" placeholder="Token" id="projectToken"/>
      <input style="float: left;" class="myInput credInput" placeholder="API Key" id="projectKey"/>
      <input style="float: left;" class="myInput credInput" placeholder="API Secret" id="projectSecret"/>
      <a class="button button_primary credInput" id="submitCred">Set API Credentials</a>
      
      <div style="clear: both;"></div>
    </div>
    <div style="display:none;" id="mp_toolbox" class="mixpanel-platform-section">
      <h2>Resurface Events</h2>
      <h3>Enter your events here to resurface</h3>
      <div class="mixpanel-platform-section">
          <div style="clear: both;"></div>
          <div id="dateSelect" style="float: left;"></div>
          <input style="float: left;" class="myInput" placeholder="Page Viewed, Button Clicked" id="events"/>
          <button class="button button_primary" id="run_query">Search Events</button>
          <div style="clear: both;"></div>
          <br/>
          <a style="display:none;" class="button button_primary" id="resurface_events" href="#">Export to CSV</a>
        </div>
    </div>
  
    <script>
        $("#submitCred").click(function() {
          MP.api.setCredentials($('#projectKey').val(), $('#projectSecret').val());
          $("#mp_toolbox").show();
          $(".credInput").hide();
          $(".myDisplay").show();
          $("#displayName").html("Project Name: " + $('#projectName').val());
        });
        $(".myDisplay").click(function() {
          $("#mp_toolbox").show();
          $(".myDisplay").hide();
          $(".credInput").show();
        });
    </script>
 
    <!--Custom Query Scripts Go Here - KEEP IT CLEAN -->
    <script>
      var events;
      var token = $('#projectToken').val();
      var dateSelect  = $('#dateSelect').MPDatepicker();

      $('#run_query').on('click', function(e) {
          $('#run_query').html("Please Wait...").prop("disabled", true);
          events = $('#events').val();
          runQuery();
        
      });
      
      $("body").delegate("#resurface_events", "click", function() {
          var csv = "data:text/csv;charset=utf-8," + json_to_csv.jsonToCSV(last_response);
          $(this).attr("href", encodeURI(csv)).attr("download",
              "Survey_Export_" + survey_id + "_" + moment().format('MMM-DD-YYYY') + ".csv");
          $('#resurface_events').hide();
      });
      
    var runQuery = function() {
      dateRange = dateSelect.MPDatepicker('value');
      var queryParams = {
        from_date: dateRange.from.toISOString().split('T')[0],
        to_date: dateRange.to.toISOString().split('T')[0],
        token: token,
        events: events.split(","),
      };
      var script = $('#cq_survey').html();
      script = $.trim(script);
      MP.api.custom_query(script, queryParams)
        .done(function(resp) {
            $('#run_query').html("Search Events").prop("disabled", false);
            last_response = resp;
            $('#resurface_events').show();

        }).fail(function($xhr) {
            $('#run_query').html("Search Events").prop("disabled", false);
            // Somehow the request is not parsed into JSON event with application/json header
            var error = $xhr.request.responseText;
            var error_text = "Requst failed";
            try {
                error_text = JSON.parse(error).error;
            } catch (err) {
                error_text = $xhr.request.responseText;
            }
        });
      }
    </script>
    <script type="text/cq" id="cq_survey">
      function main() {
        return Events({
          from_date: params.from_date,
          to_date:  params.to_date,
          event_selectors: eventsSelected()
        })
        .groupBy(["name"], function(accums, events) {
          var holder = {
            'properties': {}
          };
            _.each(accums, function(v) {
                holder.event = v.event;
                _.extend(holder.properties, v.properties);
            });
          _.each(events, function(v) {
            holder.event = v.name;
            _.each(v.properties, function(value, key) {
              var prop = {};
              prop[key] = "import";
              _.extend(holder.properties, prop);
            });
          });
          return holder;
        }).map(function(event) {
          var resurface = {
            properties: {
                'token': params.token,
                'time': _.now(),
                'ip': '0'
              }
          };
          _.extend(resurface, event.value);
          return resurface;
        });
      }
      function eventsSelected(){
        var events = [];
        _.each(params.events, function(v) {
          events.push({event: v.trim()});
        });
        return events;
      }
    </script>
</body>
</html>
